{% load static %}

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{% block title %}InstaClone{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
    rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'css/navbar.css' %}">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'css/feed.css' %}">
    <link rel="stylesheet" href="{% static 'css/profile.css' %}">
    <link rel="stylesheet" href="{% static 'css/post.css' %}">
    <link rel="stylesheet" href="{% static 'css/auth.css' %}">
    
</head>

<body class="bg-light">

    {% include 'accounts/navbar.html' %}

    <main class="container py-4">
        {% block content %}
        {% endblock %}
    </main>

    <script 
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
    </script>

    <script>
        const searchInput = document.getElementById("search-input");
        const resultsBox = document.getElementById("search-results");

        if (searchInput && resultsBox) {
            let controller = null;
            let debounceTimer = null;

            searchInput.addEventListener("input", function () {
                const query = this.value.trim();

                clearTimeout(debounceTimer);

                debounceTimer = setTimeout(() => {
                    if (!query) {
                        resultsBox.classList.add("d-none");
                        resultsBox.innerHTML = "";
                        return;
                    }
                
                    if (controller) controller.abort();
                    controller = new AbortController();

                    fetch(`/search/ajax/?q=${encodeURIComponent(query)}`, { 
                        signal: controller.signal,
                        headers: {'X-Requested-With': 'XMLHttpRequest'} 
                    })
                    .then(res => res.json())
                    .then(data => {
                        resultsBox.innerHTML = "";

                        if (data.results.length === 0) {
                            resultsBox.innerHTML = 
                                `<div class="p-3 text-muted small">No results</div>`;
                        } else {
                            data.results.forEach(user => {
                                resultsBox.innerHTML += `
                                    <a href="${user.profile_url}"
                                        class="search-item d-flex align-items-center px-3 py-2 text-decoration-none text-dark">
                                        <img src="${user.avatar}"
                                            class="rounded-circle me-2"
                                            width="40" height="40">
                                        <div>
                                            <strong>${user.username}</strong><br>
                                            <small class="text-muted">${user.display_name}</small>
                                        </div>
                                    </a>     
                                    `;   
                                });
                            }
                            
                        resultsBox.classList.remove("d-none");

                    })
                    .catch(err => {
                        if (err.name !== "AbortError") console.error(err);
                    });

                }, 300);
            });

            document.addEventListener("click", e => {
                if (!searchInput.contains(e.target) && 
                    !resultsBox.contains(e.target)) {
                        resultsBox.classList.add("d-none");
                    }
            });
        }
        
    </script>

    <script>
        document.addEventListener("click", function (e) {
            const btn = e.target.closest(".like-btn");
            if (!btn) return;

            const postId = btn.dataset.postId;

            fetch(`/interactions/like/${postId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
            .then(res => res.json())
            .then(data => {
                const icon = btn.querySelector("i");
                const countEl = btn
                    .closest(".insta-post")
                    ?.querySelector(".likes-count strong");

                if (data.liked) {
                    icon.classList.remove("bi-heart");
                    icon.classList.add("bi-heart-fill", "text-danger");
                } else {
                    icon.classList.remove("bi-heart-fill", "text-danger");
                    icon.classList.add("bi-heart");
                }

                if (countEl) {
                    countEl.textContent = data.likes_count;
                }
            });
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                document.cookie.split(';').forEach(cookie => {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                    }
                });
            }

            return cookieValue;
        }
        
    </script>

</body>
</html>
